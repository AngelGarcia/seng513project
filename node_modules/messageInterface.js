var messages = require('message'),
	url = require('url');

var ListMessages = exports.ListMessages = function() {
};
var viewMessage = exports.viewMessage = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 * @param issue Issue to display
 */
function displayMessagesPage(response, user) {
	// Get the inbox messages
	messages.getMessages(user, 0, function(error, iMsgList) {
		messages.getMessages(user, 1, function(error, sMsgList) {
			var variables = {
					title: 'dori',
					user: user,
					inboxMsgList: iMsgList,
					sentMsgList: sMsgList
				}
			response.render('views/listMessages.html', variables);
		});
	});
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
ListMessages.display = function(request, response) {
	//var parsedURL = url.parse(request.url, true);
	
	//util.log(parsedURL);
	
	// TODO: check the session id from the cookie, then look up which user it is that way
	// This will do for now though..
	
	// Get logged-in user and call display
	request.getUser(function(error, user){
		if(error)
			util.log("Error getting user in messageInterface.display. " + error);
		if (user) {
			// Display msgs
			displayMessagesPage(response, user.id);
		}
		else
			response.render('views/listMessages.html');
	});
};



viewMessage.display = function(request, response) {
	var parsedURL = url.parse(request.url, true);
	
	//util.log(parsedURL.query.folderid);
	//util.log(parsedURL.query.msgid);
	
	// TODO: check the session id from the cookie, then look up which user it is that way
	// This will do for now though..
	
	// Get logged-in user and call display
	request.getUser(function(error, user){
		if(error)
			util.log("Error getting user in messageInterface.display. " + error);
		if (user) {
			// Display msgs
			displayMessage(response, user.id, parsedURL.query.msgid, parsedURL.query.folderid);
		}
		else
			response.render('views/viewMessage.html');
	});
};


function displayMessage(response, user, msgId, folderId) {
	// Get the inbox messages
util.log(folderId);
util.log(msgId);
messages.getMessage(msgId, folderId, function(error, message) {
if(error)
	throw error; 
			var variables = {
					title: 'dori',
					user: user,
					fromUserName: message.from_name,
					msgDate: message.date,
					msgSubject: message.subject,
					msgBody: message.body
				}

			response.render('views/viewMessage.html', variables);
});
};
