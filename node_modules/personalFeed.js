/* personalFeed.js 
 * Provides a page with recent events on the site. Users who are logged in see a personal feed.  
 */ 

var dbAccess = require('dbAccess'),
	dateUtil = require('dateUtil'),
	recentActivity = require('recentActivity'), 
	step = require('step'),
	stringUtil = require('stringUtil'), 
	util = require('util');
	
var NUM_ACTIVITIES = 20; // The number of activites to show 

/* generateActivityFeed
 * Produces the response for a personal feed when a user is logged in. 
 * If no user is defined, it will just show the recent activity on the site 
 * 
 * 'res' A node Http.Response object 
 * 'user' The user (optional) 
 */ 
function generateActivityFeed(res, user) {
	function generateResponse(error, results) {
		step(
			function loadData() {
				var userIds = []; 
				for (r in results) { 
					userIds.push(results[r].contents.user_id); 
				}
				getUserNames(userIds, this.parallel());
			},
			function handleCallback(err, userNames) {
				if (err) throw error;
				
				var activityList = []; 
				var currentDate = new Date(); 
				for (var i = 0; i < results.length; i++) {
					var activity; 
					var activityType = results[i].type; 
					activity = {
						type: results[i].type,
						isIssue: (results[i].type == 'issue') ? true : false, 
						isComment: (results[i].type == 'comment') ? true : false, 
						id: results[i].contents.id,
						title: (results[i].contents.title) ? results[i].contents.title.abbreviate(60) : '',
						userId: results[i].contents.user_id, 
						username: userNames[results[i].contents.user_id],
						howLongAgo: currentDate.howLongAgo(results[i].contents.created), 
						issueId: (activityType == 'comment') ? results[i].contents.issue_id : results[i].contents.id, 
						comment: (activityType == 'comment' && results[i].contents.content) ? results[i].contents.content.abbreviate(60) : ''
					}; 
					activityList.push(activity);  
				}
				
				var variables = { 
					content: activityList
				}
			
				res.render('views/personalFeed.html', variables); 
			}
		);
	}
	
	if (user) { 
		recentActivity.getUserRecentActivityList(user.id, NUM_ACTIVITIES, generateResponse); 
	} 
	else { 
		recentActivity.getRecentActivityList(NUM_ACTIVITIES, generateResponse); 
	}
}

/* getUserNames  
 * Gets the names of users based off a list of user ids 
 * 
 * 'userIds' A list of users ids 
 * 'callback' A callback (error, results) where results is an array with user names 
 *
 * TODO: Improve the performance and efficiency of this function 
 */ 
function getUserNames(userIds, callback) {
	var names = []; 
	dbAccess.find('users', { properties : [ 'id', 'name' ] }, function(error, results) {
		for (r in results) { 
			if (contains(userIds, results[r].id)) { 
				names[new String(results[r].id)] = (results[r].name); 
			}
		}
		callback(error, names); 
	});
}

/* contains 
 * Checks if an array contains an object 
 * 
 * 'a' The array 
 * 'obj' The object to look for in the array 
 */ 
function contains(a, obj) {
	var i = a.length;
	while (i--) {
		if (a[i] === obj) {
			return true;
		}
	}
	return false;
}

/* display 
 * Determines what to render 
 *
 * 'req' A node http request object 
 * 'res' A node http response object 
 */ 
exports.display = function(req, res) {
	req.getUser(function(error, user) {
		if (error) throw error;
		generateActivityFeed(res, user);  
	}); 	
}
