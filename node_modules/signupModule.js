/*
 * Module for new user signup 
 *
 * Created By: Jonathan Moore, Corliss Fung, Nasrullah Taha
 */ 

var sqlite = require('sqlite');
var qs = require('querystring');


var SignupModule = exports.SignupModule = function() { 
	this.username;
	this.email;
	this.password;
};

/*
 * Create a new user in the database
 */
SignupModule.handleSignup = function(request, res) 
{
	console.log("New user signup initiated.");

	// The form data from the request is first read into SignupBody
	var signupBody = '';	
	request.on('data', function(chunk){
		signupBody += chunk.toString();
	});
	
	
	// When all data is received, the data is parsed and inserted into database
	request.on('end', function(){
		// parse the signup form information
		var signupInfo = qs.parse(signupBody);
		this.username = signupInfo['username'];
		this.email = signupInfo['email'];
		this.password = signupInfo['password'];

		// open database connection, and insert the new user into the database
		var db = new sqlite.Database();
		db.open("CivicConnect.db", function (error) {});

		var sqlInsertNewUser = "INSERT INTO 'users' ('name', 'email', 'password') "
				+ "VALUES ('" + this.username + "', '" + this.email + "', '" + this.password + "');";
		db.execute(sqlInsertNewUser, function(error, rows){
			// If a database error is generated, just spit out failure message
			if(error) {
				console.log('error occured saving to DB:' + error.toString());
				res.writeHead(500, { 'Content-Type' : 'text/html' }); 
				res.end('<html><body><h1>Signup Failed</h1></body></html>');
			}
			// On success, redirect user to Welcome page.
			else {
				console.log('database save successful!');
				res.writeHead(302, { 'Location' : '/signupSuccess.html' }); 
				res.end();
			}
			db.close(function(error){});
		});			
	});
}



