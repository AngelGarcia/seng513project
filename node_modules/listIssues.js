var dbAccess = require('dbAccess');
var url = require('url');

/* Database variable */

var ListIssues = exports.ListIssues = function() {
};


/**
* Prints the list of issues
* Cprresponding
*/
function printPage(response) 
{
    return function(error, rows) 
	{	
        if (error) throw error;
		response.write('<!DOCTYPE html>');
		response.write('<html>');
	
		response.write('<head>');
        
        response.write('<title>Welcome To CivicConnect - Your City, Your Voice</title>');
		response.write('<meta charset="utf-8" />');
		response.write('<link rel="stylesheet" href="css/style.css" type="text/css" />');
        response.write('</head>');
        response.write('<body>');
		response.write('<div id="page">');
        response.write('<div id="header"><a href="#">join</a> | <a href="#">login</a></div>');
        response.write('<div id="menu">');
        response.write('<ul>');
        response.write('<li><a href="index.html">Home</a></li>');
        response.write('<li><a href="about.html">About</a></li>');
        response.write('</ul>');
        response.write('</div>');
        response.write('<div id="quick-task-bar">');
        response.write('<a href="#" id="add-issue-button">Add Issue</a>');
        response.write('<form id="search-form">');
        response.write('<input type="text" id="search-box" name="search" value="" />');
        response.write('<input type="submit" id="search-button" value="Search" />');
        response.write('</form>');
        response.write('</div>');
		response.write('<div id="content">');
		response.write('<h1>Latest Issues</h1>');
		response.write('<div class="issue-container">');
		
		response.write('<table style="width: 100%">');
		response.write('<tr>');
		response.write('<td class="text-center-style" style="width: 69px"><h3><a href="listIssues?sortby=status">Status</a></h3></td>');
		response.write('<td class="text-center-style" style="width: 201px"><h3><a href="listIssues?sortby=title">Title</a></h3></td>');
		response.write('<td class="text-center-style"><h3><a href="listIssues?sortby=lastModified">Last Modified</a></h3></td>');
		response.write('</tr>');
		
	
		var i=0;
		for (i=0; i<rows.length; i++)
		{
			response.write('<tr>');	

			//Column 1
			response.write('<td style="width: 69px" class="text-center-style">');
			response.write(rows[i]['status']);
			response.write('</td>');


			//Column 2
			response.write('<td style="width: 201px" class="text-center-style">');
			response.write('<a href="./viewIssue?id=' + rows[i]['id'] + '">');
			response.write(rows[i]['title']);
			response.write('</a>');
			response.write('</td>');			
										
			//Column 3
			response.write('<td class="text-center-style">');
			response.write(rows[i]['lastModified']);
			response.write('</td>');
			
			response.write('</tr>');
		}
		response.write('</table>');	
		response.write('</div> </div> </div> <div id="footer"><p>&copy; 2011 University of Calgary. All rights reserved.</p></div></body> </html>');
		
		response.end();
    };
}

function sortQuery(sortby) {
	if(sortby) {
		return (" ORDER BY " + sortby);
	}
	else {
		return "";
	}
}


/**
* Main function of the module
* @param request Incoming request
* @param response Response object to send the data
*/
ListIssues.display = function(request, response) {
    var parsedURL = url.parse(request.url, true);

    var sqlQuery = 'SELECT * FROM issues' + sortQuery(parsedURL.query['sortby']);
    dbAccess.runQuery(sqlQuery, printPage(response));
}

