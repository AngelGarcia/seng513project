/*
 *	addIssue.js
 */
var AddIssue = exports.AddIssue = function() {
};

var querystring = require('querystring'),
    util = require('util');
    dbAccess = require('dbAccess'),
	tags = require('tags.js');

var loggedIn = 'false';

AddIssue.checkIfUserisLoggedIn = function (req)
{
	req.getUser(function(error, user){
		if(error)
			throw error;
		if(user)
			loggedIn = 'true';
		else 
			loggedIn = 'false';
		})
}
	
variables = {title: "Latest Issues"}
	
AddIssue.display = function(req, res) {
	AddIssue.checkIfUserisLoggedIn(req);
	
	variables.display = "true";
	if (loggedIn == 'true'){
		variables.loggedIn = "true";
	}
	res.render('views/addIssue.html', variables);
}

/* 
 * Handle POST form	
 */
AddIssue.add = function(req, res) {
	variables.add = "true";

    if (req.method == 'POST') {
	
		// from the form data given, parse them according to their respective form objects
        req.addListener('data', function(chunk) {
					console.log(chunk);
            var POST = querystring.parse(chunk+"");
				// insert issue from the form 
                dbAccess.create('issues', { values: ['user_id="332338"',
                                            'status="online"',
                                            'title="' + POST.title+'"',
                                            'description="'+ POST.description +'"',
                                            'link="' + POST.link+'"',
                                            'location="' + POST.location+'"']},
					// if an error occurred when inserting a new issue, print out the error
					function(error, issueId) {
						if (error)
						{
							console.log("Error inserting into database!"); 
							console.log(error); 
							dberror = true;
							// using history.back() function to go back to previous page to retain input form data
							variables.error = "true";						
						}
						else
						{
							console.log("Successfully added a new issue with id " + issueId);
							console.log("user_id = " + POST.title); 
							console.log("title = " + POST.title); 
							console.log("description = " + POST.description); 
							console.log("link = " + POST.link); 
							console.log("location = " + POST.location); 
							console.log("tags = " + POST.tags);
											
							// Now add the tags if any were entered
							if (POST.tags) {
								tags.tagIssue(issueId, POST.tags, function (error) {
									if (error) {
										util.log("error adding tags in addIssue");
										variables.fail = "true";
									}
									else {
										variables.index = "'/index.html'";
										util.log("Issue " + issueId + " tagged successfully.");
										variables.success = "true";
									}
								});
							}
							else {
								util.log("no tags to add..done!");
								util.log("Issue " + issueId + " tagged successfully.");
								// Show the success page
								variables.success = "true";
							}
						}
                }); // end create
        }); // end listener
    } // end if
	res.render('views/addIssue.html', variables);
}
