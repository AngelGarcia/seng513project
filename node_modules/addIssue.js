/*
 *	addIssue.js
 */
var AddIssue = exports.AddIssue = function() {
};

var querystring = require('querystring'),
    util = require('util');
    dbAccess = require('./dbAccess'),
	url = require('url'),
	tags = require('tags.js');

/* 
 * Handle POST form	
 */
AddIssue.add = function(req, res) {
	if (req.method == 'POST') {
		// from the form data given, parse them according to their respective form objects
		req.addListener('data', function(chunk) {
			var POST = querystring.parse(chunk);
			res.writeHead(200);
			// insert issue from the form
			dbAccess.create('issues', { values: ['user_id="332338"',
                                            'status="online"',
                                            'title="' + POST.title+'"',
                                            'description="'+ POST.description +'"',
                                            'link="' + POST.link+'"',
                                            'location="' + POST.location+'"',
											'tags="' + POST.tags+'"']}, function(error) {
				if (error) {
					util.log("Error inserting into database!"); 
					util.log(error); 
					dberror = true;
					res.end('<html><body><h1>Failed to Add Issue </h1></body></html>');
				}
				else {
					// Now add the tags
					// First get the id of the newly added issue
					dbAccess.runQuery("SELECT last_insert_rowid() \"id\";", function (error, results) {
						if (error) {
							util.log(error);
							util.log("error creating tags in addIssue");
						}
						else {
							var issueID = rows[0].id;
							util.log("New issue with id " + issueID + " added to the DB successfully.");
							tags.tagIssue(issueId, POST.tags, function (error) {
								if (error)
									util.log("error adding tags in addIssue");
								else
									util.log("Issue " + issueId + " tagged successfully.");
							});
						}
					});
				}
			});
		}); // end listener
	} // end if
}

