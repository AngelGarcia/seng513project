var dbAccess = require('dbAccess');
var url = require('url');

/* Database variable */

var SearchIssue = exports.SearchIssue = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 * @param issue Issue to display
 */
function displayPage(response, searchTerm) {
	return function(error, rows) 
	{	
        if (error) throw error;
		// remove duplicate rows - if the search term was found in the same id more than once
		var unique = new Array();
		o:for(var i in rows)
		{
			for(var j in unique)
			{
				if(rows[i].issue_id==unique[j].issue_id) continue o;
			}
			unique[unique.length] = rows[i];
		}
		//
		response.write('<!DOCTYPE html>');
		response.write('<html>');

		response.write('<head>');
        
        response.write('<title>Welcome To CivicConnect - Your City, Your Voice</title>');
		response.write('<meta charset="utf-8" />');
		response.write('<link rel="stylesheet" href="css/style.css" type="text/css" />');
        response.write('</head>');
        response.write('<body>');
		response.write('<div id="page">');
        response.write('<div id="header"><a href="#">join</a> | <a href="#">login</a></div>');
        response.write('<div id="menu">');
        response.write('<ul>');
        response.write('<li><a href="index.html">Home</a></li>');
        response.write('<li><a href="about.html">About</a></li>');
        response.write('</ul>');
        response.write('</div>');
        response.write('<div id="quick-task-bar">');
        response.write('<a href="#" id="add-issue-button">Add Issue</a>');
        response.write('<form action="searchIssue" id="search-form">');
        response.write('<input type="text" id="search-box" name="search" value="" />');
        response.write('<input type="submit" id="search-button" value="Search" />');
        response.write('</form>');
        response.write('</div>');
		response.write('<div id="content">');
		response.write('<h1>Search results for: '+searchTerm+'</h1>');
		response.write('<div class="issue-container">');

		response.write('<table style="width: 100%">');
		response.write('<tr>');
		response.write('<td class="text-center-style" style="width: 100px"><h3>Status</h3></td>');
		response.write('<td class="text-center-style" style="width: 501px"><h3>Title</h3></td>');		
		response.write('<td class="text-center-style"><h3>Last Modified</h3></td>');
		response.write('</tr>');


		var i=0;
		for (i=0; i<unique.length; i++)
		{
			response.write('<tr>');	

			//Column 1
			response.write('<td style="width: 69px" class="text-center-style">');
			response.write(unique[i]['status']);
			response.write('</td>');


			//Column 2
			response.write('<td style="width: 201px" class="text-center-style">');
			response.write('<a href="./viewIssue?id=' + unique[i]['issue_id'] + '">');
			response.write(unique[i]['title']);
			response.write('</a>');
			response.write('</td>');			

			//Column 3
			response.write('<td class="text-center-style">');
			response.write(unique[i]['lastModified']);
			response.write('</td>');

			response.write('</tr>');
		}
		response.write('</table>');	
		response.write('</div> </div> </div> <div id="footer"><p>&copy; 2011 University of Calgary. All rights reserved.</p></div></body> </html>');

		response.end();
    };
}

/**
 * Retrieve the user corresponding to the issue
 * @param response Response object to send the data
 */
function findWord(response) {
    return function(error, rows) {
        if (error) throw error;
        displayPage(response, rows);
    };
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
SearchIssue.display = function(request, response) {
    var parsedURL = url.parse(request.url, true);
	var searchTerm = parsedURL.query.search;
	var searchTerms = searchTerm.split(' ');
	var matching = '';
	for(var i in searchTerms)
	{
		var termStripped = searchTerms[i].replace(/[^A-Za-z0-9]/g,'').toLowerCase();
		matching += 'keywords.keyword="'+termStripped+'"';
		if(i != searchTerms.length-1)
			matching += ' OR ';
	}
	var sqlQuery = 'SELECT * FROM keywords JOIN indexTable ON keywords.id=indexTable.keyword_id JOIN issues ON issues.id=indexTable.issue_id WHERE '+matching;
	dbAccess.runQuery(sqlQuery, displayPage(response, searchTerm));
}
