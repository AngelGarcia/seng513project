var dbAccess = require('dbAccess.js');
var url = require('url');

var EditIssue = exports.EditIssue = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 */
function serve(response,id) {
    return function(error, rows) {
      if (rows[0]==undefined) {
	  response.writeHeader(404, {"Content-Type": "text/html"});
	  response.end('<html><body><h1>404 Not Found</h1></body></html>');
	}
	else {
        var issue = rows[0];
	response.write('<!doctype html> <html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>');
	response.write('<title>CivicConnect</title><link rel="stylesheet" href="css/style.css" type="text/css" /></head>');
        response.write('<body> <div id="page"><div id="header"><a href="#">join</a> | <a href="#">login</a> </div> <div id="menu"><ul><li><a href="index.html">Home</a></li><li><a href="about.html">About</a></li></ul></div><div id="content">');
  	response.write('<h1>Edit Issue Details</h1>');
	response.write('<form id="edit_issue" action="saveIssue" method="post">');
	response.write('<p><input type="hidden" name="id" value= "'+id + '"/></p>');
	response.write('<p>Title</p> <p><input type="text" name="title" value= "'+issue['title'] + '"/></p>');
	response.write('<p>Description</p><p><textarea rows="10" cols="50" name="description">'+issue['description'] + '</textarea></p>');
	response.write('<p>Location</p> <p><input type="text" name="location" value= "'+issue['location'] + '"/></p>');
	response.write('<p>Link</p> <p><input type="text" name="link" value= "'+issue['link'] + '"/></p>');
	response.write('<SELECT name="status">');
	response.write('<OPTION VALUE="open"');if (issue['status']=='open') response.write('SELECTED');response.write('>Open</OPTION>');
	response.write('<OPTION VALUE="resolved" ');if (issue['status']=='resolved') response.write('SELECTED');response.write('>Resolved</OPTION>');
	response.write('</SELECT>');
	response.write('<p><input type="submit" value="Save Issue" /></p></form>');
	response.write('</div> <div id="footer"><p>&copy; 2011 University of Calgary. All rights reserved.</p></div></div></body> </html>');

        response.end();

	}
    };
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
EditIssue.display = function(request, response) {
    var parsedURL = url.parse(request.url, true);
    
    var sqlQuery = 'SELECT * FROM issues WHERE id=' + parsedURL.query.id;
    dbAccess.runQuery(sqlQuery, serve(response,parsedURL.query.id));
}
