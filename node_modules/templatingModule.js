Mustache = require('mustache'),
fs = require('fs');

var layoutsPath = 'views/layouts/';
var defaultLayoutPath = layoutsPath + 'defaultLayout.html';
var defaultPageTitle = 'CivicConnect';

exports.render = function(template, view, partials, send_fun){
	res = this;
	view = view || {}; //Removes the need to pass in the 'view' argument.
	layoutContent = {};
	
	layoutContent.error = view.error;
	layoutContent.pageTitle = view.pageTitle || defaultPageTitle;
	
	fs.readFile(template, function(error, contentData){
		if(error)
			throw error;
		
		// TODO: don't like nesting two file IO's. Can we do these in parallel?
		// 		and if in parallel would we have a race condition?
		//		or better yet, consider keeping the layoutfile in memory.
		fs.readFile(defaultLayoutPath, function(error, layoutData){
			if(error)
				throw error;
			
			contentHTML = Mustache.to_html(contentData.toString(), view, partials, send_fun);
			
			layoutContent.content = contentHTML.toString();
			
			fullHTML = Mustache.to_html(layoutData.toString(), layoutContent);
			
			res.write(fullHTML);
			res.end();
		});
	});
}

exports.redirectTo = function(route){
	this.statusCode = 302;
	this.setHeader('Location', route);
	this.end();
}