var dbAccess = require('dbAccess');
var url = require('url');

var ViewIssue = exports.ViewIssue = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 * @param issue Issue to display
 */
function displayPage(response, issue,id) {
    return function(error, rows) {
        var user = rows[0];
        response.write('<!doctype html> <html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>');
	response.write('<title>CivicConnect</title><link rel="stylesheet" href="css/style.css" type="text/css" /></head>');
         response.write('<body>');
        response.write('<div id="page">');
        response.write('<div id="header"><a href="#">join</a> | <a href="#">login</a></div>');
        response.write('<div id="menu">');
        response.write('<ul>');
        response.write('<li><a href="index.html">Home</a></li>');
        response.write('<li><a href="about.html">About</a></li>');
        response.write('</ul>');
        response.write('</div>');
        response.write('<div id="quick-task-bar">');
        response.write('<a href="editIssue?id='+id+'" id="add-issue-button">Edit Issue</a>');
        response.write('<form id="search-form">');
        response.write('<input type="text" id="search-box" name="search" value="" />');
        response.write('<input type="submit" id="search-button" value="Search" />');
        response.write('</form>');
        response.write('</div>');
        response.write('<div id="content">');
  	response.write('<h1>' + issue['title'] + '</h1>');
        response.write('Created on ' + issue['created']);
	if (user!=undefined) response.write('by  <a href="/viewProfile?id='+issue['user_id']+ '" id="user_profile">' +user['name']+ '</a> <br />');
	else response.write('<br />');
        response.write('Status: ' + issue['status']+'<br/>');
	response.write('Location: ' + issue['location']);
        response.write('<h3>Description</h3>');
        response.write('<p>'+issue['description'] + '</p><br/>');
        response.write('More information: <a href="' + issue['link'] + '"> here </a>');
	response.write('</div> <div id="footer"><p>&copy; 2011 University of Calgary. All rights reserved.</p></div></div></body> </html>');

        response.end();
    };
}

/**
 * Retrieve the user corresponding to the issue
 * @param response Response object to send the data
 */
function findUser(response,id) {
    return function(error, rows) {
        if (error) throw error;
	if (rows[0]==undefined) {
	  response.writeHeader(404, {"Content-Type": "text/html"});
	  response.end('<html><body><h1>404 Not Found</h1></body></html>');
	}
	else  dbAccess.runQuery('SELECT * FROM users WHERE id=' + rows[0]['user_id'], displayPage(response, rows[0],id));
    };
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
ViewIssue.display = function(request, response) {
    var parsedURL = url.parse(request.url, true);

    var sqlQuery = 'SELECT * FROM issues WHERE id=' + parsedURL.query.id;
    dbAccess.runQuery(sqlQuery, findUser(response,parsedURL.query.id));
}
