var dbAccess = require('dbAccess');
var url = require('url');
var g_UserId = -1; //User ID
var g_UserVote; //Whether Thumbs Up or Thumbs Down

var ViewIssue = exports.ViewIssue = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 * @param issue Issue to display
 */
function displayPage(response, issue, id) {
	return function(error, users)
	{
		var user = users[0];
		
		g_UserVote = -1; //Assume that the user hasn't voted initially
		
		//Check if the user has already voted
		var sqlAlreadyVoted = "SELECT * FROM votes WHERE user_id = " + g_UserId	 + " AND issue_id = " + issue['id'];
		
		dbAccess.runQuery(sqlAlreadyVoted, function(error, rows_vote)
		{			
			if (error) throw error;
			
			if (rows_vote.length == 1)
			{
				g_UserVote = rows_vote[0]['vote'];	
			}
			
			variables = {
				quickTaskButtons_partial: 'views/layouts/partials/quickTaskButtons_partial.html',
				quickTaskButtons: {id: issue.id},
			
				title: issue.title,
				created: issue.created,
				user: user,
				user_id: user.id,
				user_name: user.name,
				status: issue.status,
				location: issue.location,
				description: issue.description,
				link: issue.link,
				id: issue.id,
				userHasVoted: g_UserVote != -1,
				userLiked: g_UserVote == 0
			}
			
			response.render('views/viewIssue.html', variables)

		}); 
	};
}

/**
 * Retrieve the user corresponding to the issue
 * @param response Response object to send the data
 */
function findUser(response,id) {
		return function(error, issue) {
				if (error) throw error;

		dbAccess.runQuery('SELECT * FROM users WHERE id=' + issue[0]['user_id'], displayPage(response, issue[0], id));

	};
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
ViewIssue.display = function(request, response) {
	var parsedURL = url.parse(request.url, true);
		
	// get logged-in user
	request.getUser(function(error, user){
		if(error) throw error;
		if (user)	g_UserId = user.id;
		var sqlQuery = 'SELECT * FROM issues WHERE id=' + parsedURL.query.id;
		dbAccess.runQuery(sqlQuery, findUser(response,parsedURL.query.id));
	});
};
