var dbAccess = require('dbAccess');
var url = require('url');
var g_UserId; //User ID
var g_UserVote; //Whether Thumbs Up or Thumbs Down

/* Database variable */

var ViewIssue = exports.ViewIssue = function() {
};

/**
 * Send the HTML page to the client
 * @param response Response object to send the data
 * @param issue Issue to display
 */
function displayPage(response, issue) {
    return function(error, rows) {
		
		if (rows.length == 0)
		{
			/* A quick fix for now in case the issue is not found. the JS alert could be replaced by a generic Error Page: mumansoo*/
			response.write('<html><script language=\'JavaScript\'>alert(\'An Error occured trying to display the details of an issue!\'),history.go(-1)</script></html>');
			response.end();	
			return;
		}
		
		
        var user = rows[0];
		
		g_UserId = 1; //NOTE: This statement is here for reference only and should be replaced with req.user.user_id
		              //Once Cody's changes are uploaded
					  
		g_UserVote = -1; //Assume that the user hasn't voted initially
		
		//Check if the user has already voted
		var sqlAlreadyVoted = "SELECT * FROM votes WHERE user_id = " + g_UserId  + " AND issue_id = " + issue['id'];
		console.log(sqlAlreadyVoted);
		
		dbAccess.runQuery(sqlAlreadyVoted, function(error, rows_vote)
		{
			if (error)
			{
				console.log("error");
			}
			
			if (rows_vote.length == 1)
			{
				g_UserVote = rows_vote[0]['vote'];	
			}
			
			console.log("The length is " + rows_vote.length);

		response.write('<head>');
        response.write('<meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>');
        response.write('<link rel="stylesheet" href="css/style.css" type="text/css" />');
        response.write('<title>CivicConnect</title>');
        response.write('</head>');
        response.write('<body>');
        response.write('<div id="page">');
        response.write('<div id="header"><a href="#">join</a> | <a href="#">login</a></div>');
        response.write('<div id="menu">');
        response.write('<ul>');
        response.write('<li><a href="index.html">Home</a></li>');
        response.write('<li><a href="about.html">About</a></li>');
        response.write('</ul>');
        response.write('</div>');
        response.write('<div id="quick-task-bar">');
        response.write('<a href="#" id="add-issue-button">Add Issue</a>');
        response.write('<form id="search-form">');
        response.write('<input type="text" id="search-box" name="search" value="" />');
        response.write('<input type="submit" id="search-button" value="Search" />');
        response.write('</form>');
        response.write('</div>');
        response.write('<div id="content">');
		response.write('<h1>' + issue['title'] + '</h1>');
        response.write('Created on ' + issue['created'] + ' by ' + user['name'] + '<br />');
        response.write('Status: ' + issue['status']);
        response.write('<h3>Description</h3>');
        response.write(issue['description'] + '<br />');
        response.write('More information: <a href="' + issue['link'] + '"> here </a>');		
		
		console.log("gUserVote " + g_UserVote);
		
		if (g_UserVote == -1)
		{
			response.write('<br><table style="width: 100%"><tr>	<td style="width: 31px"><a href="/voteIssues?issueid=' + issue['id'] +  '&vote=0"><img src="images/thumb_up.png"></a></td>');
			response.write('<td style="width: 49px">Like</td><td style="width: 31px"><a href="/voteIssues?issueid=' + issue['id'] +  '&vote=1"><img src="images/thumb_down.png"></a></td>');
			response.write('<td>Unlike</td></tr></table>');	
		}
		else if (g_UserVote == 0)
		{
			response.write('<br><i>You Liked this Issue<i>');
		}
		else 
		{
			response.write('<br><i>You Disliked this Issue<i>');
		}
		
		response.write('</div> <div id="footer"><p>&copy; 2011 University of Calgary. All rights reserved.</p></div></div></body> </html>');
		response.end();
			
			
		});	

        
    };
}

/**
 * Retrieve the user corresponding to the issue
 * @param response Response object to send the data
 */
function findUser(response) {
    return function(error, rows) {
        if (error) throw error;
		
		if (rows.length == 0)
		{
			/* A quick fix for now in case the issue is not found. the JS alert could be replaced by a generic Error Page: mumansoo*/
			response.write('<html><script language=\'JavaScript\'>alert(\'An Error occured trying to display the details of an issue!\'),history.go(-1)</script></html>');
			response.end();	
			return;
		}
		
        dbAccess.runQuery('SELECT * FROM users WHERE id=' + rows[0]['user_id'], displayPage(response, rows[0]));
    };
}

/**
 * Main function of the module
 * @param request Incoming request
 * @param response Response object to send the data
 */
ViewIssue.display = function(request, response) {
    var parsedURL = url.parse(request.url, true);

    var sqlQuery = 'SELECT * FROM issues WHERE id=' + parsedURL.query.id;
    dbAccess.runQuery(sqlQuery, findUser(response));
}
